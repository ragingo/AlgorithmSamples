#!/bin/bash

# Generate PR-friendly clang-tidy report

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CPP_DIR="$(dirname "$SCRIPT_DIR")"

echo "Generating clang-tidy report for PR..."

cd "$CPP_DIR" || exit 1

# Run clang-tidy and generate structured output
find . -path "./build" -prune -o -path "./_deps" -prune -o \
    \( -name "*.cpp" -o -name "*.hpp" -o -name "*.h" \) -type f -print | \
    while IFS= read -r file; do
        echo "Analyzing: $file"

        # Run clang-tidy on individual file
        clang-tidy "$file" \
            --checks="-*,modernize-*,readability-*,performance-*,bugprone-*,-clang-diagnostic-error" \
            --extra-arg=-std=c++23 \
            --extra-arg=-I. \
            --format-style=file 2>&1 | \
            grep -E "^.*\.(cpp|hpp|h):[0-9]+:[0-9]+: warning:" | \
            while IFS= read -r warning; do
                echo "LINT_WARNING: $warning"
            done
    done > lint_warnings.txt

# Count warnings
WARNING_COUNT=$(grep -c "LINT_WARNING:" lint_warnings.txt || echo "0")

echo "Found $WARNING_COUNT warnings"

# Generate summary for PR
echo "## ðŸ” Clang-tidy Analysis Results" > pr_lint_summary.md
echo "" >> pr_lint_summary.md

if [ "$WARNING_COUNT" -gt 0 ]; then
    echo "Found **$WARNING_COUNT** code style/quality issues:" >> pr_lint_summary.md
    echo "" >> pr_lint_summary.md

    # Group by issue type and show most common issues
    echo "### ðŸ“Š Most Common Issues:" >> pr_lint_summary.md
    echo "" >> pr_lint_summary.md
    echo "| ãƒ«ãƒ¼ãƒ« | ä»¶æ•° | èª¬æ˜Ž |" >> pr_lint_summary.md
    echo "|--------|------|------|" >> pr_lint_summary.md

    grep "LINT_WARNING:" lint_warnings.txt | sed 's/LINT_WARNING: //' | \
        sed -E 's/.*\[([^]]*)\]$/\1/' | sort | uniq -c | sort -nr | head -5 | \
        while read count rule; do
            case "$rule" in
                "readability-identifier-length")
                    description="å¤‰æ•°åãŒçŸ­ã™ãŽã¾ã™ (3æ–‡å­—ä»¥ä¸ŠæŽ¨å¥¨)"
                    ;;
                "modernize-use-trailing-return-type")
                    description="æˆ»ã‚Šå€¤ã®åž‹ã‚’å¾Œç½®ã«ã™ã‚‹ã“ã¨ã‚’æŽ¨å¥¨"
                    ;;
                "readability-identifier-naming")
                    description="å¤‰æ•°åã®å‘½åè¦å‰‡ã«å¾“ã£ã¦ã„ã¾ã›ã‚“"
                    ;;
                "bugprone-easily-swappable-parameters")
                    description="å¼•æ•°ã®é †åºã‚’é–“é•ãˆã‚„ã™ã„æ§‹é€ ã§ã™"
                    ;;
                "readability-function-size")
                    description="é–¢æ•°ãŒå¤§ãã™ãŽã¾ã™"
                    ;;
                *)
                    description="ã‚³ãƒ¼ãƒ‰å“è³ªã®æ”¹å–„ãŒå¿…è¦ã§ã™"
                    ;;
            esac
            echo "| \`$rule\` | $count | $description |" >> pr_lint_summary.md
        done

    echo "" >> pr_lint_summary.md
    echo "### ðŸ“ Detailed Issues:" >> pr_lint_summary.md
    echo "" >> pr_lint_summary.md
    echo "| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ | å•é¡Œã®èª¬æ˜Ž | ãƒ«ãƒ¼ãƒ« |" >> pr_lint_summary.md
    echo "|----------|----|-----------|---------| " >> pr_lint_summary.md

    # Process warnings and format as table rows
    grep "LINT_WARNING:" lint_warnings.txt | sed 's/LINT_WARNING: //' | \
        sed -E 's|^.*[/\\]([^/\\]+):([0-9]+):[0-9]+: warning: (.*) \[([^]]*)\]$|\1\t\2\t\3\t\4|' | \
        sort -u | head -10 | \
        while IFS=$'\t' read -r file line message rule; do
            echo "| \`$file\` | $line | $message | \`$rule\` |" >> pr_lint_summary.md
        done

    if [ "$WARNING_COUNT" -gt 10 ]; then
        echo "... and **$((WARNING_COUNT - 10))** more issues" >> pr_lint_summary.md
        echo "" >> pr_lint_summary.md
    fi

    echo "### ðŸ’¡ Quick Fixes:" >> pr_lint_summary.md
    echo "" >> pr_lint_summary.md
    echo "Common issues and solutions:" >> pr_lint_summary.md
    echo "- **readability-identifier-length**: Use descriptive variable names (3+ chars)" >> pr_lint_summary.md
    echo "- **modernize-use-trailing-return-type**: Consider using \`auto function() -> type\` syntax" >> pr_lint_summary.md
    echo "- **modernize-use-nodiscard**: Add \`[[nodiscard]]\` to functions that return important values" >> pr_lint_summary.md
    echo "- **readability-function-cognitive-complexity**: Break down complex functions" >> pr_lint_summary.md
    echo "" >> pr_lint_summary.md
    echo "ðŸ’¡ **Tip**: Run \`bash cpp/scripts/lint.sh\` locally to see all issues with context." >> pr_lint_summary.md
else
    echo "ðŸŽ‰ **Great job!** No code style or quality issues found." >> pr_lint_summary.md
fi

echo "" >> pr_lint_summary.md
echo "---" >> pr_lint_summary.md
echo "*This comment was automatically generated by clang-tidy CI check.*" >> pr_lint_summary.md

echo "Report generated: pr_lint_summary.md"
